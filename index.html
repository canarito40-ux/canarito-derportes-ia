<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canarito Deportes | Noticias IA üáÆüá®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .news-card { transition: all 0.3s ease; }
        .news-card:hover { transform: translateY(-3px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col min-h-screen custom-scrollbar">

    <!-- Encabezado Principal -->
    <header class="bg-slate-900 text-white p-6 sticky top-0 z-50 shadow-2xl border-b border-blue-900/30">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-black tracking-tighter italic">
                    <span class="text-blue-500">CANARITO</span><span class="text-white">DEPORTES</span>
                </h1>
                <p class="text-blue-400/80 text-[10px] uppercase tracking-[0.3em] font-bold mt-1">Inteligencia Artificial ‚Ä¢ Periodismo Canario</p>
            </div>
            
            <div class="flex items-center gap-4 bg-slate-800/50 p-3 rounded-2xl border border-slate-700/50 backdrop-blur-sm">
                <div class="text-right border-r border-slate-700 pr-4">
                    <p class="text-[9px] uppercase text-slate-500 font-black tracking-widest">Lectores Reales</p>
                    <div class="flex items-center justify-end text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <span class="text-xl font-black leading-none" id="visit-count">0</span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[9px] uppercase text-slate-500 font-black tracking-widest">Sistema</p>
                    <p class="text-[10px] font-black flex items-center gap-1.5" id="db-status">
                        <span class="h-2 w-2 rounded-full bg-amber-500 animate-pulse"></span> CONECTANDO
                    </p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">
        
        <!-- Sidebar -->
        <aside class="lg:col-span-4 order-2 lg:order-1">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 sticky top-32">
                <div class="flex items-center gap-3 mb-8">
                    <div class="h-10 w-2 bg-blue-600 rounded-full"></div>
                    <h2 class="text-2xl font-black text-slate-800 uppercase italic tracking-tighter">Redacci√≥n IA</h2>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-2">Cobertura Actual</label>
                        <select id="topic" class="w-full rounded-2xl border-slate-200 bg-slate-50 p-4 text-sm font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 border-2 transition-all cursor-pointer appearance-none text-slate-700">
                            <option value="UD Las Palmas">‚öΩ UD Las Palmas</option>
                            <option value="CD Tenerife">‚öΩ CD Tenerife</option>
                            <option value="La Laguna Tenerife (ACB)">üèÄ La Laguna Tenerife</option>
                            <option value="Dreamland Gran Canaria (ACB)">üèÄ Dreamland Gran Canaria</option>
                            <option value="UDG Tenerife Egatesa">‚ôÄÔ∏è F√∫tbol Femenino</option>
                            <option value="Lucha Canaria">ü§º Lucha Canaria</option>
                        </select>
                    </div>

                    <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-[0.98] disabled:opacity-50 uppercase text-xs tracking-[0.2em]">
                        Publicar Noticia Ahora
                    </button>

                    <div id="loading" class="hidden bg-blue-50 p-6 rounded-2xl border border-blue-100 border-dashed text-center">
                        <div class="inline-block animate-spin h-6 w-6 border-4 border-blue-600 border-t-transparent rounded-full mb-3"></div>
                        <p class="text-[10px] font-black text-blue-800 uppercase tracking-widest">Generando contenido actualizado...</p>
                    </div>

                    <div id="statusMessage" class="hidden p-4 rounded-2xl text-[11px] font-bold text-center border"></div>
                </div>
            </div>
        </aside>

        <!-- Feed Principal -->
        <section class="lg:col-span-8 order-1 lg:order-2">
            <div class="flex items-center justify-between mb-10 pb-4 border-b-2 border-slate-100">
                <h2 class="text-3xl font-black text-slate-900 italic uppercase tracking-tighter flex items-center gap-3">
                    √öltima Hora
                    <span class="flex h-3 w-3 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-600"></span>
                    </span>
                </h2>
            </div>

            <div id="news-container" class="space-y-8">
                <div id="loading-initial" class="text-center py-32">
                    <div class="inline-block animate-bounce h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                        <span class="text-blue-600 font-bold">...</span>
                    </div>
                    <p class="text-xs font-black text-slate-400 uppercase tracking-[0.3em]">Cargando noticias...</p>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChegdpKCVYlK3Yk6UbaFQKBEBplH-9AY8",
            authDomain: "noticias-canarito-ia.firebaseapp.com",
            projectId: "noticias-canarito-ia",
            storageBucket: "noticias-canarito-ia.firebasestorage.app",
            messagingSenderId: "505533621228",
            appId: "1:505533621228:web:b297fc2f76da4bd13c56c9"
        };
        
        const appId = 'noticias-canarito-ia';
        const apiKey = ""; // API Key gestionada por el entorno

        const dbStatus = document.getElementById('db-status');
        const visitCountEl = document.getElementById('visit-count');
        const generateBtn = document.getElementById('generateBtn');
        const newsContainer = document.getElementById('news-container');
        const statusMessage = document.getElementById('statusMessage');

        let db, auth, user = null;

        const startApp = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Esperar Auth antes de cualquier operaci√≥n de DB
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        dbStatus.innerHTML = `<span class="h-2 w-2 rounded-full bg-green-500"></span> ONLINE`;
                        dbStatus.className = "text-[10px] font-black text-green-400 flex items-center gap-1.5";
                        
                        if (!sessionStorage.getItem('canarito_v7_active')) {
                            registerNewVisit();
                            sessionStorage.setItem('canarito_v7_active', 'true');
                        }
                        syncData();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (e) { console.error(e); }
        };

        async function registerNewVisit() {
            if (!user) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'stats'), {
                    type: 'visit',
                    timestamp: serverTimestamp()
                });
            } catch (e) {}
        }

        function syncData() {
            if (!user) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'news'), (snap) => {
                document.getElementById('loading-initial').classList.add('hidden');
                const news = snap.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderNews(news);
            }, (err) => console.error(err));

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stats'), (snap) => {
                visitCountEl.textContent = snap.size || 0;
            });
        }

        function renderNews(news) {
            if (news.length === 0) {
                newsContainer.innerHTML = `<div class="bg-white p-24 rounded-[3rem] text-center border-4 border-dashed border-slate-100 text-slate-300 font-black uppercase tracking-[0.2em] italic">No hay noticias a√∫n</div>`;
                return;
            }
            newsContainer.innerHTML = news.map(n => `
                <article class="news-card bg-white p-8 md:p-12 rounded-[2.5rem] shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-2 h-full bg-blue-600 transition-all group-hover:w-3"></div>
                    <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                        <span class="bg-blue-600 text-white text-[10px] font-black px-5 py-2 rounded-xl uppercase tracking-widest">${n.topic || 'Deportes'}</span>
                        <span class="text-[11px] text-slate-400 font-black uppercase">${n.timestamp ? new Date(n.timestamp.toMillis()).toLocaleString() : 'Justo ahora'}</span>
                    </div>
                    <h3 class="text-2xl md:text-4xl font-black text-slate-900 mb-8 leading-tight italic uppercase">${n.title}</h3>
                    <div class="text-slate-600 leading-relaxed whitespace-pre-line text-base md:text-lg">${n.content}</div>
                </article>
            `).join('');
        }

        // Funci√≥n de llamada a la API con Exponential Backoff
        async function fetchAI(prompt, retries = 5, delay = 1000) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Eres un periodista deportivo de Canarias. No uses asteriscos ni lenguaje de marcado." }] },
                tools: [{ "google_search": {} }]
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) return await response.json();
                    if (response.status === 429) { /* Rate limit, continue to retry */ }
                } catch (e) {
                    if (i === retries - 1) throw e;
                }
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
            throw new Error("No se pudo conectar con el servidor de noticias.");
        }

        async function postNews() {
            if (!user) return;
            const topic = document.getElementById('topic').value;
            generateBtn.disabled = true;
            document.getElementById('loading').classList.remove('hidden');
            statusMessage.classList.add('hidden');

            try {
                const prompt = `Escribe una noticia real de hoy sobre ${topic} en Canarias. L√≠nea 1: Titular. P√°rrafos siguientes: cuerpo de la noticia (3 p√°rrafos cortos). No uses asteriscos.`;
                const data = await fetchAI(prompt);
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!rawText) throw new Error("La redacci√≥n est√° ocupada, intenta en un momento.");

                const lines = rawText.trim().split('\n').filter(l => l.trim().length > 0);
                const title = lines[0].replace(/[#*]/g, '').trim();
                const content = lines.slice(1).join('\n\n').replace(/[*]/g, '').trim();

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'news'), {
                    title: title || "Actualidad Deportiva",
                    content: content || "Estamos redactando los detalles.",
                    topic,
                    timestamp: serverTimestamp()
                });
                
                showStatus("‚úÖ Publicada con √©xito", false);
            } catch (e) {
                showStatus("‚ùå " + e.message, true);
            } finally {
                generateBtn.disabled = false;
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function showStatus(msg, isError) {
            statusMessage.textContent = msg;
            statusMessage.className = `p-4 rounded-2xl text-[11px] font-bold text-center border ${isError ? 'bg-red-50 text-red-700 border-red-200' : 'bg-green-50 text-green-700 border-green-200'}`;
            statusMessage.classList.remove('hidden');
        }

        generateBtn.addEventListener('click', postNews);
        startApp();
    </script>
</body>
</html>
