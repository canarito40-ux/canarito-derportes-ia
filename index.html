<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias Deportivas Canarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .news-card { transition: all 0.3s ease; }
        .news-card:hover { transform: translateY(-4px); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-gray-900 text-white p-6 shadow-xl">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-black tracking-tighter text-blue-500">CANARITO<span class="text-white underline decoration-blue-600">DEPORTES</span></h1>
                <p class="text-gray-400 text-sm font-medium">Información deportiva canaria generada por IA</p>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-[10px] uppercase tracking-widest text-gray-500 mb-1">Estado del Servidor</span>
                <span class="px-3 py-1 rounded-full text-xs font-bold bg-gray-800 border border-gray-700" id="db-status">Cargando...</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6 flex-grow grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- Panel de Control -->
        <div class="lg:col-span-4">
            <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 sticky top-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="bg-blue-600 w-2 h-8 rounded mr-3"></span>
                    Redacción Virtual
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label for="topic" class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-wide">Seleccionar Fuente</label>
                        <select id="topic" class="w-full rounded-xl border-gray-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4 border bg-gray-50 text-gray-700 font-medium">
                            <option value="UD Las Palmas">UD Las Palmas</option>
                            <option value="CD Tenerife">CD Tenerife</option>
                            <option value="La Laguna Tenerife (ACB)">La Laguna Tenerife (ACB)</option>
                            <option value="Dreamland Gran Canaria (ACB)">Dreamland Gran Canaria (ACB)</option>
                            <option value="UDG Tenerife Egatesa">Fútbol Femenino (Tenerife)</option>
                            <option value="Lucha Canaria">Lucha Canaria</option>
                        </select>
                    </div>

                    <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 px-6 rounded-xl shadow-lg transition-all active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed uppercase tracking-widest">
                        Generar Noticia de Hoy
                    </button>
                    
                    <div id="loading" class="hidden">
                        <div class="flex flex-col items-center justify-center p-6 bg-blue-50 rounded-2xl border-2 border-dashed border-blue-200">
                            <svg class="animate-spin h-8 w-8 text-blue-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-xs font-bold text-blue-800 text-center uppercase">La IA está analizando la prensa deportiva...</span>
                        </div>
                    </div>

                    <div id="statusMessage" class="hidden p-4 rounded-xl text-sm font-bold animate-pulse"></div>
                </div>
            </div>
        </div>

        <!-- Feed de Noticias -->
        <div class="lg:col-span-8">
            <h2 class="text-3xl font-black mb-8 text-gray-900 flex items-center uppercase italic">
                Última Hora
                <span class="ml-4 flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-3 w-3 rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                </span>
            </h2>
            
            <div id="news-container" class="space-y-8">
                <!-- Las noticias aparecerán aquí -->
                <div id="loading-initial" class="flex flex-col items-center justify-center py-20 text-gray-400">
                    <p class="font-bold uppercase tracking-widest animate-pulse">Conectando con la base de datos...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-900 text-gray-600 p-8 mt-12 border-t border-gray-800 text-center">
        <p class="text-[10px] uppercase tracking-[0.3em]">PROYECTO CANARITO IA • 2024 • DATOS REALES EN TIEMPO REAL</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN DE TU FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyChegdpKCVYlK3Yk6UbaFQKBEBplH-9AY8",
            authDomain: "noticias-canarito-ia.firebaseapp.com",
            projectId: "noticias-canarito-ia",
            storageBucket: "noticias-canarito-ia.firebasestorage.app",
            messagingSenderId: "505533621228",
            appId: "1:505533621228:web:b297fc2f76da4bd13c56c9",
            measurementId: "G-FQNMK5D8BH"
        };
        
        const apiKey = ""; // API Key de Gemini

        const generateBtn = document.getElementById('generateBtn');
        const loadingDiv = document.getElementById('loading');
        const statusMessage = document.getElementById('statusMessage');
        const newsContainer = document.getElementById('news-container');
        const topicSelect = document.getElementById('topic');
        const dbStatus = document.getElementById('db-status');
        const loadingInitial = document.getElementById('loading-initial');

        function showStatus(msg, isError = true) {
            statusMessage.textContent = msg;
            statusMessage.className = `p-4 rounded-xl text-sm font-bold ${isError ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-green-100 text-green-700 border border-green-200'}`;
            statusMessage.classList.remove('hidden');
        }

        // Inicializar Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);
            
            signInAnonymously(auth).then(() => {
                dbStatus.textContent = "ONLINE";
                dbStatus.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-900 text-green-400 border border-green-800";
            });
        } catch (e) {
            dbStatus.textContent = "OFFLINE";
            dbStatus.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-900 text-red-400 border border-red-800";
        }

        const newsCol = collection(db, 'news');

        const renderNews = (docs) => {
            if (docs.length === 0) {
                newsContainer.innerHTML = `
                    <div class="bg-white p-20 rounded-3xl shadow-inner border-4 border-dashed border-gray-100 text-center">
                        <p class="text-gray-400 font-black uppercase tracking-widest text-xl">No hay noticias en portada</p>
                        <p class="text-gray-300 text-sm mt-2">Usa el panel de la izquierda para redactar la primera</p>
                    </div>`;
                return;
            }

            // Ordenar por fecha manualmente por si acaso
            const sorted = [...docs].sort((a, b) => {
                const timeA = a.data().timestamp?.toMillis() || 0;
                const timeB = b.data().timestamp?.toMillis() || 0;
                return timeB - timeA;
            });

            newsContainer.innerHTML = sorted.map(doc => {
                const n = doc.data();
                const fecha = n.timestamp ? new Date(n.timestamp.toMillis()).toLocaleString('es-ES', { day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit' }) : 'Recién publicado';
                return `
                    <article class="news-card bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                            <span class="bg-blue-600 text-white text-[10px] font-black uppercase px-4 py-1.5 rounded-full tracking-widest">${n.topic}</span>
                            <span class="text-xs text-gray-400 font-bold uppercase tracking-tighter italic border-b border-gray-100">${fecha}</span>
                        </div>
                        <h3 class="text-2xl font-black text-gray-900 mb-4 leading-tight">${n.title}</h3>
                        <div class="text-gray-600 text-base leading-relaxed space-y-4 whitespace-pre-line">${n.content}</div>
                    </article>
                `;
            }).join('');
        };

        async function generateNews() {
            const topic = topicSelect.value;
            loadingDiv.classList.remove('hidden');
            generateBtn.disabled = true;
            statusMessage.classList.add('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Actúa como redactor jefe de un periódico deportivo de Canarias. Busca noticias reales y actuales sobre "${topic}". Escribe una noticia estructurada: El primer párrafo debe ser un titular potente sin símbolos extraños. Luego escribe tres párrafos de cuerpo de noticia con información verídica de las últimas 24 horas.` }] }],
                        tools: [{ google_search: {} }]
                    })
                });

                const result = await response.json();
                const fullText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!fullText) throw new Error("La IA no devolvió respuesta. Reinténtalo.");

                const lines = fullText.trim().split('\n').filter(l => l.trim().length > 0);
                const title = lines[0].replace(/[#*]/g, '').trim();
                const content = lines.slice(1).join('\n\n').trim();

                await addDoc(newsCol, {
                    title,
                    content,
                    topic,
                    timestamp: serverTimestamp()
                });

                showStatus("¡Noticia publicada en el feed principal!", false);
                setTimeout(() => statusMessage.classList.add('hidden'), 5000);

            } catch (err) {
                console.error(err);
                showStatus(`Error: ${err.message}`);
            } finally {
                loadingDiv.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }

        // Suscribirse a cambios en tiempo real
        onSnapshot(newsCol, (snap) => {
            loadingInitial.classList.add('hidden');
            renderNews(snap.docs);
        }, (error) => {
            console.error(error);
            showStatus("Error de permisos: Verifica que Firestore esté en 'Modo de Prueba'.");
        });

        generateBtn.addEventListener('click', generateNews);
    </script>
</body>
</html>
