<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias Deportivas Canarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-gray-900 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold tracking-tight">Deportes Canarias IA</h1>
            <span class="text-xs text-blue-400 font-mono" id="db-status">Estado: Desconectado</span>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow grid grid-cols-1 md:grid-cols-3 gap-6">

        <div class="col-span-1 md:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit sticky top-4 border border-gray-100">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Redacción IA</h2>
            <div class="mb-4">
                <label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Elegir competición/equipo:</label>
                <select id="topic" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-gray-50 text-gray-700">
                    <option value="UD Las Palmas">UD Las Palmas</option>
                    <option value="CD Tenerife">CD Tenerife</option>
                    <option value="La Laguna Tenerife (ACB)">La Laguna Tenerife (ACB)</option>
                    <option value="Dreamland Gran Canaria (ACB)">Dreamland Gran Canaria (ACB)</option>
                    <option value="UDG Tenerife Egatesa">Fútbol Femenino (Costa Adeje)</option>
                    <option value="Lucha Canaria">Lucha Canaria</option>
                </select>
            </div>
            <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Generar Noticia Actualizada
            </button>
            
            <div id="loading" class="mt-4 text-center text-gray-500 hidden">
                <div class="flex items-center justify-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm font-medium text-blue-800">Consultando fuentes deportivas...</span>
                </div>
            </div>

            <div id="statusMessage" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
        </div>

        <div class="col-span-1 md:col-span-2">
            <h2 id="noticias" class="text-3xl font-bold mb-6 text-gray-800 border-b-4 border-blue-600 pb-2 inline-block">Portada de Hoy</h2>
            <div id="news-container" class="space-y-6">
                <div id="loading-initial" class="flex flex-col justify-center items-center h-48 text-gray-400">
                    <div class="animate-pulse flex space-x-4">
                        <div class="rounded-full bg-gray-200 h-10 w-10"></div>
                        <div class="flex-1 space-y-6 py-1">
                            <div class="h-2 bg-gray-200 rounded"></div>
                            <div class="space-y-3">
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="h-2 bg-gray-200 rounded col-span-2"></div>
                                    <div class="h-2 bg-gray-200 rounded col-span-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mt-4 text-sm font-medium">Conectando con la red de noticias...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-900 text-gray-500 text-center p-6 mt-12 border-t border-gray-800">
        <p class="text-xs uppercase tracking-widest">Información en tiempo real • Powered by Gemini AI</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- TUS DATOS DE FIREBASE ACTUALIZADOS ---
        const firebaseConfig = {
            apiKey: "AIzaSyChegdpKCVYlK3Yk6UbaFQKBEBplH-9AY8",
            authDomain: "noticias-canarito-ia.firebaseapp.com",
            projectId: "noticias-canarito-ia",
            storageBucket: "noticias-canarito-ia.firebasestorage.app",
            messagingSenderId: "505533621228",
            appId: "1:505533621228:web:b297fc2f76da4bd13c56c9",
            measurementId: "G-FQNMK5D8BH"
        };
        // ----------------------------------------
        
        const geminiApiKey = "AIzaSyB7dsq5xGobd6Px5v5KfCE-BplAnfX5z5k"; 

        const generateBtn = document.getElementById('generateBtn');
        const loadingDiv = document.getElementById('loading');
        const statusMessage = document.getElementById('statusMessage');
        const newsContainer = document.getElementById('news-container');
        const topicSelect = document.getElementById('topic');
        const dbStatus = document.getElementById('db-status');
        const loadingInitial = document.getElementById('loading-initial');

        function showMessage(msg, isError = true) {
            statusMessage.textContent = msg;
            statusMessage.className = `mt-4 p-3 rounded-lg text-sm ${isError ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'}`;
            statusMessage.classList.remove('hidden');
        }

        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            dbStatus.textContent = "Estado: Conectado";
            dbStatus.className = "text-xs text-green-400 font-mono";
        } catch (e) {
            console.error(e);
            dbStatus.textContent = "Estado: Error";
            showMessage("Error al inicializar Firebase. Revisa los datos pegados.");
        }

        const newsCol = collection(db, 'news');

        const renderNews = (docs) => {
            if (docs.length === 0) {
                newsContainer.innerHTML = '<div class="text-center p-12 bg-white rounded-xl shadow-sm text-gray-400 italic">No hay noticias. ¡Genera la primera noticia de Canarias!</div>';
                return;
            }
            
            const sorted = [...docs].sort((a, b) => (b.data().timestamp?.toMillis() || 0) - (a.data().timestamp?.toMillis() || 0));

            newsContainer.innerHTML = sorted.map(doc => {
                const n = doc.data();
                const fecha = n.timestamp ? new Date(n.timestamp.toMillis()).toLocaleString('es-ES') : 'Recién publicado';
                return `
                    <article class="bg-white p-6 rounded-xl shadow-md border-l-8 border-blue-600 transform transition hover:-translate-y-1">
                        <div class="flex justify-between items-center mb-4">
                            <span class="bg-blue-100 text-blue-800 text-[10px] font-black uppercase px-2 py-1 rounded-full">${n.topic}</span>
                            <span class="text-xs text-gray-400 font-medium">${fecha}</span>
                        </div>
                        <h3 class="text-xl font-extrabold text-gray-900 mb-3 leading-tight">${n.title}</h3>
                        <p class="text-gray-600 text-sm leading-relaxed whitespace-pre-line">${n.content}</p>
                    </article>
                `;
            }).join('');
        };

        async function generateNews() {
            const topic = topicSelect.value;
            loadingDiv.classList.remove('hidden');
            generateBtn.disabled = true;
            statusMessage.classList.add('hidden');

            try {
                // Usamos la API de Gemini con búsqueda en Google para noticias reales
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Busca noticias reales hoy sobre "${topic}". Escribe una noticia periodística completa de Canarias con un título impactante y 3 párrafos de texto. Usa datos reales de las últimas 48 horas.` }] }],
                        tools: [{ google_search: {} }]
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) throw new Error("La IA no devolvió texto. Revisa si la búsqueda está habilitada.");

                const lines = text.trim().split('\n').filter(l => l.length > 0);
                const title = lines[0].replace(/[#*]/g, '').trim();
                const content = lines.slice(1).join('\n').trim();

                await addDoc(newsCol, {
                    title,
                    content,
                    topic,
                    timestamp: serverTimestamp()
                });

                showMessage("¡Noticia generada y guardada con éxito!", false);
                setTimeout(() => statusMessage.classList.add('hidden'), 3000);

            } catch (err) {
                console.error(err);
                showMessage(`Error al generar noticia: ${err.message}`);
            } finally {
                loadingDiv.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }

        (async () => {
            try {
                await signInAnonymously(auth);
                onSnapshot(newsCol, (snap) => {
                    loadingInitial.classList.add('hidden');
                    renderNews(snap.docs);
                }, (error) => {
                    console.error("Firestore Error:", error);
                    showMessage("Error al leer la base de datos. ¿Activaste el 'Modo de prueba' en Firestore?");
                });
            } catch (e) {
                console.error("Auth Error:", e);
                showMessage("No se pudo conectar con el servidor de autenticación.");
            }
        })();

        generateBtn.addEventListener('click', generateNews);
    </script>
</body>
</html>
